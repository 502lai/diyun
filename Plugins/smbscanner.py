# -*- coding: utf-8 -*-
"""
cve-2020-0796
"""
import socket
import struct
import sys
from netaddr import IPNetwork

import common.config
from common import log
pkt = b'\x00\x00\x00\xc0\xfeSMB@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x08\x00\x01\x00\x00\x00\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00x\x00\x00\x00\x02\x00\x00\x00\x02\x02\x10\x02"\x02$\x02\x00\x03\x02\x03\x10\x03\x11\x03\x00\x00\x00\x00\x01\x00&\x00\x00\x00\x00\x00\x01\x00 \x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\n\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'

def smbscanner(info):
    try:
        sock = socket.socket(socket.AF_INET)
        sock.settimeout(info.Timeout)
        try:
            sock.connect((info.Host, 445))
        except:
            sock.close()
        sock.send(pkt)
        nb, = struct.unpack(">I", sock.recv(4))
        res = sock.recv(nb)

        if res[68:70] != b"\x11\x03" or res[70:72] != b"\x02\x00":
            pass
        else:
            result = "[+] {} CVE-2020-0796 SmbGhost Vulnerable".format(info.Host)
            log.LogSuccess(result)
    except Exception as e:
        pass
    finally:
        sock.close()
if __name__ == "__main__":
    info=common.config.HostInfo()
    info.Host="127.0.0.1"
    info.Timeout=3
    smbscanner(info)